{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Alestic Unreliable Town Clock https://github.com/alestic/alestic-unreliable-town-clock",

  "Parameters" : {
    "InstanceType" : {
      "Description" : "EC2 instance type",
      "Type" : "String",
      "AllowedValues" : ["t1.micro"],
      "Default" : "t1.micro"
    },
    "OperatorEmail": {
      "Description": "Email address to notify if there are any scaling operations",
      "Type" : "String",
      "MinLength": 6,
      "Default": "your-address@example.com"
    },
    "SshKeyName" : {
      "Description" : "The EC2 keypair to allow SSH access to the instances",
      "Type" : "String",
      "Default": ""
    },
    "InstallScriptURL" : {
      "Description" : "URL of script to install/configure new instances",
      "Type" : "String",
      "Default" : "https://raw.githubusercontent.com/alestic/alestic-unreliable-town-clock/master/unreliable-town-clock-bootstrap"
    }
  },

  "Mappings" : {
    "AMIRegionMap" : {
      "us-east-1"      : { "AMIID" : "ami-6ab2a702" },
      "us-west-1"      : { "AMIID" : "ami-fb7f90bf" },
      "us-west-2"      : { "AMIID" : "ami-d986b7e9" },
      "eu-central-1"   : { "AMIID" : "ami-5ac5fa47" },
      "eu-west-1"      : { "AMIID" : "ami-cf7a12b8" },
      "ap-northeast-1" : { "AMIID" : "ami-c4c807c4" },
      "ap-southeast-1" : { "AMIID" : "ami-94f0cfc6" },
      "ap-southeast-2" : { "AMIID" : "ami-b9027d83" },
      "sa-east-1"      : { "AMIID" : "ami-7b991e66" }
    }
  },

  "Resources" : {
    "ScalingNotificationTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "Subscription": [ {
            "Endpoint": { "Ref": "OperatorEmail" },
            "Protocol": "email" } ]
      }
    },

    "UnreliableTownClockTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "Subscription": [ {
            "Protocol": "email",
            "Endpoint": { "Ref": "OperatorEmail" }
        } ]
      }
    },

    "PublicSubscribeTopicPolicy": {
      "Type" : "AWS::SNS::TopicPolicy",
      "Properties" : {
          "PolicyDocument" : {
            "Version": "2008-10-17",
            "Statement": [
              {
                "Sid": "owner-policy-statement",
                "Effect": "Allow",
                "Principal": {
                  "AWS": "*"
                },
                "Action": [
                  "SNS:Publish",
                  "SNS:RemovePermission",
                  "SNS:SetTopicAttributes",
                  "SNS:DeleteTopic",
                  "SNS:ListSubscriptionsByTopic",
                  "SNS:GetTopicAttributes",
                  "SNS:Receive",
                  "SNS:AddPermission",
                  "SNS:Subscribe"
                ],
                "Resource": { "Ref": "UnreliableTownClockTopic" },
                "Condition": {
                  "StringEquals": {
                    "AWS:SourceOwner": { "Ref": "AWS::AccountId" }
                  }
                }
              },
              {
                "Sid": "public-policy-statement",
                "Effect": "Allow",
                "Principal": {
                  "AWS": "*"
                },
                "Action": [
                  "SNS:Receive",
                  "SNS:Subscribe"
                ],
                "Resource": { "Ref": "UnreliableTownClockTopic" },
                "Condition": {
                  "StringEquals": {
                    "SNS:Protocol": [
                      "email",
                      "lambda",
                      "sqs"
                    ]
                  }
                }
              }
            ]
          },
          "Topics" : [ { "Ref": "UnreliableTownClockTopic" } ]
        }
    },

    "ServerGroup" : {
      "Type" : "AWS::AutoScaling::AutoScalingGroup",
      "Properties" : {
        "AvailabilityZones" : { "Fn::GetAZs" : ""},
        "LaunchConfigurationName" : { "Ref" : "LaunchConfig" },
        "MinSize" : 1,
        "MaxSize" : 1,
        "NotificationConfiguration" : {
          "TopicARN" : { "Ref" : "ScalingNotificationTopic" },
          "NotificationTypes" : [ "autoscaling:EC2_INSTANCE_LAUNCH","autoscaling:EC2_INSTANCE_LAUNCH_ERROR","autoscaling:EC2_INSTANCE_TERMINATE", "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"]
        }
      }
    },

    "Role": {
       "Type": "AWS::IAM::Role",
       "Properties": {
          "Path": "/",
          "AssumeRolePolicyDocument": {
             "Version" : "2012-10-17",
             "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                   "Service": [ "ec2.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
             } ]
          }
       }
    },

    "RolePolicies": {
       "Type": "AWS::IAM::Policy",
       "Properties": {
          "PolicyName": "root",
          "PolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [ {
                "Effect": "Allow",
                "Action": [
                  "sns:Publish"
                ],
                "Resource": { "Ref" : "UnreliableTownClockTopic" }
            } ]
          },
          "Roles": [ { "Ref": "Role" } ]
       }
    },

    "InstanceProfile" : {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [ { "Ref" : "Role" } ]
      }
    },

    "LaunchConfig" : {
      "Type" : "AWS::AutoScaling::LaunchConfiguration",
      "Properties" : {
        "KeyName" : { "Ref" : "SshKeyName" },
        "SpotPrice" : "0.020",
        "ImageId" : { "Fn::FindInMap" : [ "AMIRegionMap", { "Ref" : "AWS::Region" }, "AMIID" ] },
        "SecurityGroups" : [ { "Ref" : "InstanceSecurityGroup" } ],
        "InstanceType" : { "Ref" : "InstanceType" },
        "InstanceMonitoring": "true",
        "IamInstanceProfile" : { "Ref" : "InstanceProfile" },
        "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
          "#!/bin/bash -ex\n",
          "exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\n",
          "install=$(mktemp /tmp/install.XXXXXX)\n",
          "curl --location --retry 10 -o $install ", { "Ref" : "InstallScriptURL" }, "\n",
          "chmod 700 $install", "\n",
          "$install ",
            "'", { "Ref" : "UnreliableTownClockTopic" }, "' ",
            "'", { "Ref" : "AWS::Region" }, "' ",
            "\n",
          ""
        ]]}}
      }
    },

    "InstanceSecurityGroup" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "SSH access from anywhere",
        "SecurityGroupIngress" : [ {
          "IpProtocol" : "tcp",
          "FromPort" : "22",
          "ToPort" : "22",
          "CidrIp" : "0.0.0.0/0"
        } ]
      }
    }
  },

  "Outputs" : {
    "SNSTopic" : {
      "Value" : { "Ref" : "UnreliableTownClockTopic" }
    }
  }
}
